From 300924a77dd32d2d8724f862e1b2454912fa71cb Mon Sep 17 00:00:00 2001
From: Mathieu Rene <mathieu.rene@gmail.com>
Date: Sun, 5 Mar 2023 20:11:23 -0500
Subject: [PATCH] Disable compiler rt builtins

---
 pkgs/development/compilers/llvm/11/compiler-rt/default.nix | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/pkgs/development/compilers/llvm/11/compiler-rt/default.nix b/pkgs/development/compilers/llvm/11/compiler-rt/default.nix
index 979ec9e23f6..021f0cd28cf 100644
--- a/pkgs/development/compilers/llvm/11/compiler-rt/default.nix
+++ b/pkgs/development/compilers/llvm/11/compiler-rt/default.nix
@@ -1,4 +1,4 @@
-{ lib, stdenv, llvm_meta, version, fetch, cmake, python3, xcbuild, libllvm, libcxxabi, libxcrypt
+{ lib, stdenv, llvm_meta, version, fetch, cmake, python3, xcbuild, libllvm, libcxxabi, libxcrypt, breakpointHook
 , doFakeLibgcc ? stdenv.hostPlatform.isFreeBSD
 }:
 
@@ -17,7 +17,7 @@ stdenv.mkDerivation {
   inherit version;
   src = fetch "compiler-rt" "0x1j8ngf1zj63wlnns9vlibafq48qcm72p4jpaxkmkb4qw0grwfy";
 
-  nativeBuildInputs = [ cmake python3 libllvm.dev ]
+  nativeBuildInputs = [ cmake python3 libllvm.dev breakpointHook ]
      ++ lib.optional stdenv.isDarwin xcbuild.xcrun;
 
   env.NIX_CFLAGS_COMPILE = toString [
@@ -25,6 +25,7 @@ stdenv.mkDerivation {
   ];
 
   cmakeFlags = [
+    "-DCOMPILER_RT_BUILD_BUILTINS=OFF"
     "-DCOMPILER_RT_DEFAULT_TARGET_ONLY=ON"
     "-DCMAKE_C_COMPILER_TARGET=${stdenv.hostPlatform.config}"
     "-DCMAKE_ASM_COMPILER_TARGET=${stdenv.hostPlatform.config}"
@@ -130,6 +131,6 @@ stdenv.mkDerivation {
     license = with lib.licenses; [ mit ncsa ];
     # compiler-rt requires a Clang stdenv on 32-bit RISC-V:
     # https://reviews.llvm.org/D43106#1019077
-    broken = stdenv.hostPlatform.isRiscV && stdenv.hostPlatform.is32bit && !stdenv.cc.isClang;
+    broken = (stdenv.hostPlatform.isRiscV && stdenv.hostPlatform.is32bit && !stdenv.cc.isClang);
   };
 }
-- 
2.39.2

